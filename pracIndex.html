<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Inventory Helper Practice</title>
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
</head>
<body>
    <div class="Container">
        <h1>Inventory Helper <small>practice version</small></h1>
        <hr />
        <div class="Container viewOne">
            <!-- Main View Template -->
            <form class="form-inline">
                <table class="table striped">
                    <thead>
                        <tr>
                            <td>Coffee</td>
                            <td>Green</td>
                            <td>Roasted</td>
                            <td>Total</td>
                        </tr>
                    </thead>
                    <tbody class="viewModels" data-bind="collection:$collection">
                    </tbody>
                    <tbody>
                         <tr>
                            <td>Total:</td>
                            <td><span class="totalGreen">0.00</span></td>
                            <td><span class="totalRoasted">0.00</span></td>
                            <td><span class="total">0.00</span></td>
                        </tr>   
                    </tbody>
                </table>
            </form>
        </div>
    </div>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
    <script src="//cdn.jsdelivr.net/backbone.epoxy/1.2/backbone.epoxy.min.js"></script>
    
    <!-- Calculator Template -->
    
    <script type="text/template" id="calcTemplate">
        <td>
        <div class="container">
            <p><%= calcModel.get("name") %></p>
            <label>Gross Weight:</label>
            <input type="text" class="calcGross" />
            <% var contList = calcModel.get("containers");
            _.each(contList.models, function(num) { %>
                <button class="btn tareButton" onclick="return false" value="<%= num.get('weight') %>"><%= num.get("name") %></button>
            <% }); %>
        </div>
        </td>
    </script>

    
    <!-- Main MVC Script -->
    
    <script>
    var Router = Backbone.Router.extend({
        routes: {
            '': 'home'
        }
    });
        
    var router = new Router();
    router.on('route:home', function() {
        console.log("We have loaded the homepage!");
    }); 
    
    //declare global tare utility function that maintains access to the original value
    var tare = function(gross, tare) {
        var original = gross;
        return {
            taredVal: function() {
               return (gross >= tare) ? (gross - tare) : 0;
            },
            originalVal: function() {
                return original;
            }
        };
    };
    
    //begin Backbone history
    Backbone.history.start();
    
    var Coffee = Backbone.Model.extend({
        defaults: {
            name: "New Coffee",
            origin: "Origin",
            greenWeight: "0.00",
            roastedWeight: "0.00",
            totalWeight: "0.00",
        },
        initialize: function() {
            console.log("New coffee model created: " + this.get("name"));
            this.on("change", function(model) {
               var changedTotal = parseFloat(model.get("greenWeight")) + parseFloat(model.get("roastedWeight"));
               model.set("totalWeight", changedTotal.toFixed(2));
            });
        }
    });
    
    var Container = Backbone.Model.extend({
        defaults: {
            name: "New Container",
            weight: "0.00"
        }
    });
    
    //establish data source for coffee collection
    var Coffees = Backbone.Collection.extend({
        url: '//c9.io/beaudavenport/inventoryhelper/workspace/pracjsonfactory.js',
        model: Coffee
    });
    
    //establish data source for inventory container collection
    var Containers = Backbone.Collection.extend({
        url: '//c9.io/beaudavenport/inventoryhelper/workspace/containerfactory.js',
        model: Container
    });
    //backbone view for calculator panel
    var CalculatorView = Backbone.View.extend({
        tagName: "tr",

        //initialize function with parent view's scope and calculate subtotal
        initialize: function(parent) {
            console.log(this.events);
            console.log(this.$el);
            var containers = new Containers();
            
            //pass down scope from parent view
            this.currentView = parent; 
            var calcPanelTarget = "<tr><td colspan='4'><table class='calcPanelTable'>" +
                "<tr><td>Running Total: <span class='calcTotal'>0.00</span><td></tr>" +
                "</table></td></tr>";
            this.$el.after(calcPanelTarget);
            this.setElement($(".calcPanelTable"));
            var self = this;
            
            //fetch updated list of containers before rendering panel
            containers.fetch().done(function() {
                //attach list of containers to coffee item model
                self.currentView.model.set("containers", containers);
                self.calcPanel = _.template($("#calcTemplate").html(), {calcModel: self.currentView.model});
                self.$el.append(self.calcPanel);
                self.delegateEvents({
                    "click .tareButton": "tare",
                    "mouseover input": "oink"
                });
                console.log(self.$el);
                console.log(self.events);
                return self;
            });    
        },
        //append additional rows
        append: function() {
            this.currentView.$el.after(this.calcPanel);    
        },
        tare: function(event) {
            console.log("you hit the tare button");
            var origWeight = parseFloat(this.$(":input").val());
            var tareWeight = parseFloat(event.currentTarget.value);
            this.lastTare = tare(origWeight, tareWeight);
            console.log(this.lastTare.taredVal());
            this.$(".calcTotal").text(this.lastTare.taredVal());    
        },
        oink: function() {
            console.log("oink");
        }
    });
    
    //epoxy item view for each coffee model
    var coffeeItemView = Backbone.Epoxy.View.extend({
        tagName: "tr",
        
        bindings: {
            "input.green": "value:greenWeight,events:['keyup']",
            "input.roasted": "value:roastedWeight,events:['keyup']",
            "span.rowTotal": "text:totalWeight,events:['keyup']"
        },
        
        events: {
            "click button.calculate": "renderCalculator"
        },
        
        initialize: function() {
            var name = this.model.get("name");
            var output = "<td>" + name + "</td>" +
                "<td><input type='text' class='green'/><button class='btn calculate' onclick='return false'>Calculate</button></td>" +
                "<td><input type='text' class='roasted'/><button class='btn calculate' onclick='return false'>Calculate</button></td>" +
                "<td><span class='rowTotal'></span></td>";
            this.$el.append(output);
            console.log("Row Added.");
        },
        
        //open calculator panel
        renderCalculator: function() {
            
            var calculatorView = new CalculatorView(this);
        }
    });
    
    //epoxy collection view for all coffee models
    var CoffeeList = Backbone.Epoxy.View.extend({
        
        el: "tbody.viewModels",
        
        collection: new Coffees(),
        
        itemView: coffeeItemView,
        
        initialize: function() {
            this.collection.fetch();
        },
        events: {
            "mouseover input": "consoleThis",
            "keyup input": "updateTotals"
        },
        
        //update vertical totals
        updateTotals: function() {
            var greenTotal = 0.00, roastedTotal = 0.00, total = 0.00;
             $('input.green').each(function() {
                greenTotal+= parseFloat(this.value);
                console.log(typeof(greenTotal) + ": " + greenTotal);
            });
            $('input.roasted').each(function() {
                roastedTotal+= parseFloat(this.value);
            });
            total = greenTotal + roastedTotal;
            $('span.totalGreen').text(greenTotal.toFixed(2));
            $('span.totalRoasted').text(roastedTotal.toFixed(2));
            $('span.total').text(total.toFixed(2)); 
            console.log(greenTotal + " + " + roastedTotal + " = " + total);
        },
        //Console Log the current target of the "event" object returned when a mouseover input event occurs.
        consoleThis: function(event) {
            var thisField = $(event.currentTarget);
            console.log('You moused over ' + thisField.val());
        }

    });
    
    var coffeeList = new CoffeeList();
    
    </script>
</body>
</html>